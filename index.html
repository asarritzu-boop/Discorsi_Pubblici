<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="icona-512.png">
<link rel="apple-touch-icon" href="icona-512.png">

<meta property="og:type" content="website">
<meta property="og:title" content="Gestione Discorsi Pubblici">
<meta property="og:description" content="Gestione Discorsi Pubblici">
<meta property="og:url" content="https://asarritzu-boop.github.io/Discorsi_Pubblici//index.html">
<meta property="og:image" content="https://asarritzu-boop.github.io/Discorsi_Pubblici//icona-512.png">
<meta property="og:image:width" content="512">
<meta property="og:image:height" content="512">
<meta property="og:image:type" content="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Discorsi Pubblici Management</title>
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://asarritzu-boop.github.io/Discorsi_Pubblici/">
    <meta property="og:title" content="Discorsi Pubblici Management">
    <meta property="og:description" content="Gestione efficiente dei discorsi pubblici.">
    <meta property="og:image" content="https://asarritzu-boop.github.io/Discorsi_Pubblici/icona-512.png">

    <meta name="theme-color" content="#21296b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icona-192.png">

    <style>
        :root {
            --ios-bg: #f2f2f7;
            --btn-calendario: #5856d6;
            --btn-schemi: #ff9500;
            --btn-esterni: #34c759;
            --btn-interni: #007aff;
            --text-light: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--ios-bg);
            margin: 0;
            display: flex; flex-direction: column; align-items: center;
            color: #1c1c1e; -webkit-tap-highlight-color: transparent;
        }

        .header { width: 100%; padding: 40px 0 20px; display: flex; flex-direction: column; align-items: center; position: relative; }
        .share-btn { position: absolute; top: 20px; right: 20px; width: 36px; height: 36px; background: rgba(0,0,0,0.06); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; color: #007aff; }
        .app-icon { width: 90px; height: 90px; border-radius: 20px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); margin-bottom: 12px; }
        h1 { font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #3a3a3c; margin: 0; }

        .menu-container { width: 90%; max-width: 380px; display: flex; flex-direction: column; gap: 15px; margin-top: 25px; }
        .btn { border: none; padding: 18px; border-radius: 14px; font-size: 15px; font-weight: 600; color: var(--text-light); text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.08); transition: transform 0.1s ease; cursor: pointer; }
        .btn:active { transform: scale(0.97); opacity: 0.9; }
        .btn-calendario { background-color: var(--btn-calendario); }
        .btn-schemi     { background-color: var(--btn-schemi); }
        .btn-esterni    { background-color: var(--btn-esterni); }
        .btn-interni    { background-color: var(--btn-interni); }

        .footer-menu { margin-top: auto; padding: 30px 0 40px; display: flex; flex-direction: column; align-items: center; gap: 8px; width: 100%; }
        .btn-backup { background: none; border: none; color: #8e8e93; font-size: 13px; font-weight: 500; padding: 8px; text-transform: uppercase; cursor: pointer; }


/* Stile per il pulsante Indietro dentro la guida */
.btn-back-guida {
    display: inline-block;
    margin: 20px;
    padding: 10px 20px;
    background: #f0f0f0;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
}
        .card { background: white; border-radius: 12px; margin-bottom: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-left: 10px; margin-right: 10px; }
        .input-group { background: white; padding: 15px; border-radius: 15px; margin: 0 10px 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        input, select, textarea { padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; width: 100%; box-sizing: border-box; }

        .modal-container { background: rgba(0,0,0,0.4); display: none; position: fixed; top:0; left:0; width:100%; height:100%; z-index: 10000; align-items: center; justify-content: center; }
        
        .clickable-name { color: var(--btn-interni); text-decoration: underline; cursor: pointer; }
        .preview-box { background: #f0f0f7; border-radius: 8px; padding: 10px; margin-top: 10px; font-size: 12px; border-left: 3px solid var(--btn-interni); }

/* Stile per il contenitore della Guida */
.view-overlay {
    display: none; 
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: white !important; /* Forza il bianco */
    z-index: 9999 !important; 
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
}

.help-btn { 
    position: absolute; top: 20px; left: 20px; 
    width: 36px; height: 36px; 
    background: var(--btn-calendario); 
    border-radius: 50%; 
    display: flex; align-items: center; justify-content: center; 
    cursor: pointer; border: none; color: white; 
    font-weight: bold; font-size: 20px; 
    z-index: 10;
}

.guida-content {
    background: #f9f9f9;
    padding: 15px;
    border-radius: 12px;
    margin-top: 15px;
}

.guida-section {
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid #ddd;
    text-align: left;
}

.btn-back-guida {
    background: #eee;
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    margin-bottom: 20px;
}
.guida-section h3 {
    margin-top: 0;
    color: #2c3e50;
    border-left: 4px solid var(--btn-calendario);
    padding-left: 10px;
}
.guida-section ul {
    padding-left: 20px;
}
.guida-section li {
    margin-bottom: 8px;
}

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

    <div id="main-menu" style="display: flex; flex-direction: column; align-items: center; width: 100%;">
        <div class="header">
<button class="help-btn" onclick="toggleView('guida')">?</button>
            <button class="share-btn" onclick="shareApp()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
            </button>
            <img src="icona-192.png" alt="App Icon" class="app-icon">
            <h1>Discorsi Pubblici Management</h1>
        </div>
        <div class="menu-container">
            <button class="btn btn-calendario" onclick="toggleView('calendario')">CALENDARIO</button>
            <button class="btn btn-schemi" onclick="toggleView('schemi')">ELENCO SCHEMI</button>
            <button class="btn btn-esterni" onclick="toggleView('esterni')">ORATORI ESTERNI</button>
            <button class="btn btn-interni" onclick="toggleView('interni')">ORATORI INTERNI</button>
        </div>
        <div class="footer-menu">
            <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="importData(event)">
            <button class="btn-backup" onclick="document.getElementById('fileInput').click()">Importa Backup</button>
            <button class="btn-backup" onclick="exportData()">Esporta Backup</button>
        </div>
    </div>

    <div id="view-schemi" class="view-overlay">
        <div style="width:95%; max-width:450px; margin:auto; padding: 20px 0;">
            <button class="btn-backup" onclick="toggleView('main')">‚Äπ Indietro</button>
            <h2 style="text-align:center;">Gestione Schemi</h2>
            <div class="input-group">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="number" id="schemaNum" placeholder="N¬∞" style="width:25%;">
                    <input type="text" id="schemaTitolo" placeholder="Titolo Discorso" style="flex:1;">
                </div>
                <button class="btn btn-schemi" onclick="salvaSchema()" style="width:100%;">SALVA / MODIFICA SCHEMA</button>
                <div style="display:flex; justify-content:space-between; margin-top:15px; flex-wrap: wrap;">
                    <button class="btn-backup" style="color:var(--btn-interni)" onclick="document.getElementById('csvInput').click()">Importa CSV</button>
                    <button class="btn-backup" style="color:#ff3b30" onclick="downloadS99()">S-99</button>
                    <button class="btn-backup" style="color:#ff3b30" onclick="generaPDFSchemiFiltrati()">Lista</button>
                    <button class="btn-backup" style="color:var(--btn-interni)" onclick="exportCSV()">Esporta CSV</button>
                    <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="importCSV(event)">
                </div>
            </div>
            
            <div class="input-group">
    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
        <input type="text" id="searchSchema" placeholder="Cerca numero o titolo..." oninput="renderSchemi()" style="flex: 1;">
        <button onclick="pulisciRicercaSchemi()" style="background: #e5e5ea; border: none; border-radius: 8px; padding: 0 15px; color: #3a3a3c; font-weight: bold; cursor: pointer;">‚úï</button>
    </div>
    <div id="counter-risultati-schemi" style="font-size: 12px; color: #8e8e93; font-weight: 500; min-height: 15px; margin-bottom: 10px;"></div>
    
    <div style="display:flex; gap:10px; align-items:center; font-size:12px; color:#666; margin-bottom:10px;">
        <span>Non fatti da</span>
        <input type="number" id="filterAnni" value="0" min="0" onchange="renderSchemi()" style="width:45px;">
        <span>anni</span>
    </div>
            
               
                <select id="sortOrder" onchange="renderSchemi()">
                    <option value="num_asc">Ordina per: Numero ‚Üë</option>
                    <option value="date_asc">Data: Pi√π Lontani ‚Üë</option>
                    <option value="date_desc">Data: Pi√π Recenti ‚Üì</option>
                </select>
            </div>
            <div id="lista-schemi-render"></div>
        </div>
    </div>

    <div id="view-calendario" class="view-overlay">
        <div style="width:95%; max-width:500px; margin:auto; padding: 20px 0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <button class="btn-backup" onclick="toggleView('main')">‚Äπ Home</button>
                <button class="btn-backup" style="color:var(--btn-calendario)" onclick="apriModalEvento()">+ AGGIUNGI EVENTO</button>
            </div>
            <div style="text-align:center; margin-bottom:15px; font-size:13px; color:#3a3a3c;">
                <strong>Giorno dell'adunanza:</strong>
                <select id="giornoAdunanza" onchange="salvaGiornoAdunanza()" style="width:auto; display:inline-block;">
                    <option value="0">Domenica</option>
                    <option value="6">Sabato</option>
                </select>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:15px; border-radius:15px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                <button onclick="cambiaMese(-1)" style="background:none; border:none; font-size:24px; color:var(--btn-calendario);">‚Äπ</button>
                <h3 id="meseCorrenteTitolo" style="margin:0; text-transform: capitalize;">Mese Anno</h3>
                <button onclick="cambiaMese(1)" style="background:none; border:none; font-size:24px; color:var(--btn-calendario);">‚Ä∫</button>
            </div>
            <div id="calendario-render"></div>
        </div>
    </div>

    <div id="view-interni" class="view-overlay">
    <div style="width:95%; max-width:600px; margin:auto; padding: 20px 0;">
        <button class="btn-backup" onclick="toggleView('main')">‚Äπ Indietro</button>
        <h2 style="text-align:center;">Gestione Oratori Interni</h2>
        
        <div class="input-group">
            <input type="text" id="oratNome" placeholder="Nome e Cognome" style="margin-bottom:10px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="oratCong" placeholder="Congregazione" style="flex:1;">
                <input type="tel" id="oratTel" placeholder="Telefono" style="flex:1;">
            </div>
            <input type="text" id="oratSchemi" placeholder="Numeri schemi (es: 1, 5, 23)" style="margin-bottom:10px;">
            <textarea id="oratNote" placeholder="Osservazioni" style="margin-bottom:10px;"></textarea>
            <button class="btn btn-interni" id="btnSalvaOratore" onclick="salvaOratore()" style="width:100%;">AGGIUNGI ORATORE</button>
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button class="btn-backup" style="color:var(--btn-interni)" onclick="document.getElementById('csvOratInput').click()">Importa CSV</button>
                <button class="btn-backup" style="color:var(--btn-interni)" onclick="exportOratoriCSV()">Esporta CSV</button>
                <input type="file" id="csvOratInput" accept=".csv" style="display:none" onchange="importOratoriCSV(event)">
            </div>
        </div>

        <div class="input-group">
            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <input type="text" id="searchOratore" placeholder="Cerca nome, numero o titolo schema..." oninput="renderOratori()" style="flex: 1;">
                <button onclick="pulisciRicercaOratori()" style="background: #e5e5ea; border: none; border-radius: 8px; padding: 0 15px; color: #3a3a3c; font-weight: bold; cursor: pointer;">‚úï</button>
            </div>
            <div id="counter-risultati" style="font-size: 12px; color: #8e8e93; font-weight: 500; min-height: 15px;"></div>
        </div>

        <div id="lista-oratori-render"></div>
    </div>
</div>


<div id="view-esterni" class="view-overlay">
    <div style="width:95%; max-width:600px; margin:auto; padding: 20px 0;">
        <button class="btn-backup" onclick="toggleView('main')">‚Äπ Indietro</button>
        <h2 style="text-align:center;">Gestione Oratori Esterni</h2>
        
        <div class="input-group">
            <input type="text" id="extNome" placeholder="Nome e Cognome" style="margin-bottom:10px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="extCong" placeholder="Congregazione" style="flex:1;">
                <input type="tel" id="extTel" placeholder="Telefono" style="flex:1;">
            </div>
            <input type="text" id="extSchemi" placeholder="Numeri schemi (es: 2, 45, 110)" style="margin-bottom:10px;">
            <textarea id="extNote" placeholder="Osservazioni"></textarea>
            <button class="btn btn-esterni" id="btnSalvaEsterno" onclick="salvaOratoreEsterno()" style="width:100%; margin-top:10px;">AGGIUNGI ORATORE ESTERNO</button>
        </div>

<div style="display:flex; justify-content:space-between; margin-top:15px;">
    <button class="btn-backup" style="color:var(--btn-esterni)" onclick="document.getElementById('csvExtInput').click()">Importa CSV</button>
    <button class="btn-backup" style="color:var(--btn-esterni)" onclick="exportEsterniCSV()">Esporta CSV</button>
    <input type="file" id="csvExtInput" accept=".csv" style="display:none" onchange="importEsterniCSV(event)">
</div>

        <div class="input-group">
    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
        <input type="text" id="searchEsterno" placeholder="Cerca congregazione, oratore o schema..." oninput="renderEsterni()" style="flex: 1;">
        <button onclick="pulisciRicercaEsterni()" style="background: #e5e5ea; border: none; border-radius: 8px; padding: 0 15px; color: #3a3a3c; font-weight: bold; cursor: pointer;">‚úï</button>
    </div>
    <div id="counter-risultati-ext" style="font-size: 12px; color: #8e8e93; font-weight: 500; min-height: 15px;"></div>
</div>

        <div id="lista-esterni-render"></div>
    </div>
</div>


    <div id="view-assegna" class="modal-container">
    <div style="background:white; width:90%; max-width:400px; padding:25px; border-radius:20px;">
        <h3 id="assignTitle" style="margin-top:0; color:var(--btn-schemi);">Assegna Schema</h3>
        <input type="hidden" id="assignNum">
        
        <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">Data Discorso</label>
        <input type="date" id="assignDate" style="margin-bottom:15px;">
        
        <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">Nome Oratore</label>
        <input type="text" id="assignOratore" list="lista-suggerimenti"
 style="margin-bottom:15px;">
        <datalist id="lista-suggerimenti"></datalist>

        <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">Luogo / Congregazione</label>
        <input type="text" id="assignLuogo" placeholder="INTERNO o Nome Congregazione" style="margin-bottom:15px;">
        
        <label id="labelSchemaInput" style="display:none; font-size:12px; color:#666; margin-bottom:5px;">Numero Schema</label>
        <input type="number" id="assignNumManuale" style="display:none; margin-bottom:20px;" placeholder="Es: 10">

        <div style="display:flex; gap:10px;">
            <button class="btn" style="flex:1; background:#8e8e93;" onclick="chiudiAssegnazione()">Annulla</button>
            <button class="btn btn-schemi" style="flex:1;" onclick="confermaAssegnazione()">Conferma</button>
        </div>
    </div>
</div>

    <div id="modal-evento" class="modal-container">
        <div style="background:white; width:90%; max-width:400px; padding:25px; border-radius:20px;">
            <h3 style="margin-top:0;">Programma Evento</h3>
            <input type="date" id="eventDate" style="margin-bottom:15px;">
            <select id="eventType" style="margin-bottom:20px;">
                <option value="Assemblea">Assemblea</option>
                <option value="Congresso">Congresso</option>
                <option value="Visita Viaggiante">Visita Viaggiante</option>
                <option value="Discorso Speciale">Discorso Speciale</option>
                <option value="Commemorazione">Commemorazione</option>
            </select>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1; background:#8e8e93;" onclick="chiudiModalEvento()">Annulla</button>
                <button class="btn btn-calendario" style="flex:1;" onclick="salvaEventoSpeciale()">Salva</button>
            </div>
        </div>
</div>

<div id="view-guida" class="view-overlay">
    <div style="max-width:800px; margin:auto; padding-bottom: 40px;">
        <button class="btn-back-guida" onclick="toggleView('main')">‚Äπ Torna alla Home</button>
        
        <h2 style="text-align:center; color: var(--btn-interni); margin-bottom:20px;">Guida all'Utilizzo</h2>
        
        <div class="guida-content">
            
            <div class="guida-section">
                <h3>üì± Menu Principale (Home)</h3>
                <p>Il punto di partenza dell'applicazione.</p>
                <ul>
                    <li><strong>Icona Condividi (alto a destra):</strong> Permette di condividere l'URL dell'app tramite le opzioni di sistema.</li>
                    <li><strong>CALENDARIO:</strong> Gestione cronologica degli impegni.</li>
                    <li><strong>ELENCO SCHEMI:</strong> Database dei discorsi e cronologia.</li>
                    <li><strong>ORATORI ESTERNI:</strong> Gestione fratelli di altre congregazioni.</li>
                    <li><strong>ORATORI INTERNI:</strong> Gestione oratori locali e schemi personali.</li>
                    <li><strong>Importa Backup:</strong> Carica un file .json per ripristinare i dati.</li>
                    <li><strong>Esporta Backup:</strong> Scarica il database attuale in formato .json.</li>
                </ul>
            </div>

            <div class="guida-section">
                <h3>üóìÔ∏è Calendario</h3>
                <p>Visualizzazione e programmazione appuntamenti.</p>
                <ul>
                    <li><strong>Giorno adunanza:</strong> Seleziona Sabato o Domenica per evidenziare i weekend corretti.</li>
                    <li><strong>Frecce ‚Äπ e ‚Ä∫:</strong> Naviga tra i mesi dell'anno.</li>
                    <li><strong>+ AGGIUNGI EVENTO:</strong> Inserisce eventi speciali (Assemblee, Congressi, Visita) che bloccano la data in rosso.</li>
                    <li><strong>Pulsante + (nel giorno):</strong> Apre la finestra di assegnazione per quella data specifica.</li>
                    <li><strong>Pulsante ‚úï (nel giorno):</strong> Elimina l'impegno o l'evento programmato.</li>
                </ul>
            </div>

            <div class="guida-section">
                <h3>üìö Gestione Schemi</h3>
                <p>Database di tutti i discorsi pubblici (S-34).</p>
                <ul>
                    <li><strong>N¬∞ e Titolo:</strong> Inserimento o modifica manuale.</li>
                    <li><strong>Importa CSV:</strong> Carica massivamente gli schemi da Excel.</li>
                    <li><strong>S-99:</strong> Scarica l'elenco predefinito CSV da importare.</li>
                    <li><strong>Lista PDF:</strong> Genera documento basato sui filtri attivi.</li>
                    <li><strong>Filtro Anni:</strong> Trova schemi non presentati da molto tempo.</li>
                    <li><strong>Icona üö´/‚úÖ:</strong> Gestione Blacklist (impedisce l'uso di schemi sospesi dalla filiale).</li>
                    <li><strong>Dettagli:</strong> Clicca sullo schema per vedere lo storico e chi lo ha pronunciato.</li>
                </ul>
            </div>

            <div class="guida-section">
                <h3>üë• Oratori (Interni ed Esterni)</h3>
                <ul>
                    <li><strong>Dati Anagrafici:</strong> Nome, Congregazione, Telefono e Note.</li>
                    <li><strong>Numeri schemi:</strong> Inserisci i numeri dei discorsi pronti (separati da virgola).</li>
                    <li><strong>Cerca:</strong> Filtra per nome, numero schema o titolo del discorso.</li>
                    <li><strong>Pulsante ‚úèÔ∏è:</strong> Modifica i dati dell'oratore.</li>
                    <li><strong>Pulsante üëÅÔ∏è:</strong> Mostra l'anteprima degli impegni futuri dell'oratore.</li>
                    <li><strong>üìÑ SCARICA PDF:</strong> Crea il programma individuale da inviare agli oratori.</li>
                    <li><strong>Assegnazione Veloce:</strong> Clicca sul nome per assegnare subito un discorso.</li>
                </ul>
            </div>

            <div class="guida-section">
                <h3>‚úçÔ∏è Finestra di Assegnazione (Modal)</h3>
                <ul>
                    <li><strong>Nome Oratore:</strong> Suggerimenti automatici con auto-completamento del luogo.</li>
                    <li><strong>Luogo:</strong> Di default impostato su "INTERNO".</li>
                    <li><strong>Verifica Conflitti:</strong> L'app segnala automaticamente se:
                        <ul>
                            <li>L'oratore ha parlato negli ultimi 3 mesi.</li>
                            <li>L'oratore ha gi√† un impegno nel mese.</li>
                            <li>Lo schema √® gi√† stato presentato in passato o √® in Blacklist.</li>
                        </ul>
                    </li>
                </ul>
            </div>

        </div>
    </div>
</div>


   <script>
        let dataVisualizzata = new Date();
        let giornoAdunanzaScelto = localStorage.getItem('giornoAdunanza') ? parseInt(localStorage.getItem('giornoAdunanza')) : 0;
        document.getElementById('giornoAdunanza').value = giornoAdunanzaScelto;

        function toggleView(view) {
    const allViews = ['main-menu', 'view-schemi', 'view-calendario', 'view-interni', 'view-esterni', 'view-guida'];

    // 1. Nascondi tutto e resetta
    allViews.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.style.display = 'none';
            el.style.setProperty('display', 'none', 'important');
        }
    });

    // 2. Mostra la vista selezionata
    if (view === 'main') {
        const menu = document.getElementById('main-menu');
        if (menu) menu.style.setProperty('display', 'flex', 'important');
    } else {
        const targetId = (view.startsWith('view-')) ? view : 'view-' + view;
        const targetEl = document.getElementById(targetId);
        
        if (targetEl) {
            // Forza la visibilit√† totale
            targetEl.style.setProperty('display', 'block', 'important');
            targetEl.style.visibility = 'visible';
            targetEl.style.opacity = '1';
            targetEl.scrollTop = 0;
        }
    }

    // 3. Esegui i render dei dati
    if (view === 'schemi') renderSchemi();
    if (view === 'calendario') renderCalendario();
    if (view === 'interni') renderOratori();
    if (view === 'esterni') renderEsterni();
}

        function getSchemi() { return JSON.parse(localStorage.getItem('schemi')) || []; }
        function getEventi() { return JSON.parse(localStorage.getItem('eventi')) || []; }
        function getOratori() { return JSON.parse(localStorage.getItem('oratori')) || []; }

        function exportData() {
            const data = JSON.stringify(localStorage);
            const blob = new Blob([data], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'backup_discorsi.json';
            a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (confirm("Sovrascrivere tutti i dati?")) {
                        localStorage.clear();
                        Object.keys(importedData).forEach(k => localStorage.setItem(k, importedData[k]));
                        location.reload();
                    }
                } catch (err) { alert("File non valido"); }
            };
            reader.readAsText(file);
        }

        async function shareApp() {
            if (navigator.share) {
                try { await navigator.share({ title: 'Discorsi Pubblici', url: window.location.href }); } catch (e) {}
            } else { alert("Link: " + window.location.href); }
        }

        function salvaSchema() {
            const num = document.getElementById('schemaNum').value;
            const titolo = document.getElementById('schemaTitolo').value;
            if(!num || !titolo) return alert("Compila i campi");
            let schemi = getSchemi();
            const idx = schemi.findIndex(s => s.num === num);
            if(idx > -1) schemi[idx].titolo = titolo;
            else schemi.push({ num, titolo, blacklist: false });
            localStorage.setItem('schemi', JSON.stringify(schemi));
            document.getElementById('schemaNum').value = '';
            document.getElementById('schemaTitolo').value = '';
            renderSchemi();
        }

        function renderSchemi() {
    const container = document.getElementById('lista-schemi-render');
    const counter = document.getElementById('counter-risultati-schemi'); // Riferimento al nuovo contatore
    const query = document.getElementById('searchSchema').value.toLowerCase();
    const anniMin = parseInt(document.getElementById('filterAnni').value) || 0;
    const sort = document.getElementById('sortOrder').value;
    const eventi = getEventi();

    // Preparazione dati con calcolo dell'ultimo discorso e dello storico
    let schemi = getSchemi().map(s => {
        const storico = eventi.filter(e => e.schemaNum === s.num).sort((a,b) => new Date(b.data) - new Date(a.data));
        return { ...s, ultimo: storico[0] || null, storico };
    });

    // Applicazione filtro di ricerca (Numero o Titolo)
    if(query) {
        schemi = schemi.filter(s => s.num.includes(query) || s.titolo.toLowerCase().includes(query));
    }

    // Applicazione filtro temporale (Anni di assenza)
    if(anniMin > 0) {
        const limite = new Date(); 
        limite.setFullYear(limite.getFullYear() - anniMin);
        schemi = schemi.filter(s => !s.ultimo || new Date(s.ultimo.data) <= limite);
    }

    // Aggiornamento del contatore visivo
    if (query || anniMin > 0) {
        counter.innerText = `Schemi trovati: ${schemi.length}`;
    } else {
        counter.innerText = "";
    }

    // Ordinamento dei risultati
    schemi.sort((a,b) => {
        if(sort === 'num_asc') return a.num - b.num;
        const dA = a.ultimo ? new Date(a.ultimo.data) : new Date(0);
        const dB = b.ultimo ? new Date(b.ultimo.data) : new Date(0);
        return sort === 'date_asc' ? dA - dB : dB - dA;
    });

    // Generazione dell'HTML
    container.innerHTML = schemi.map(s => `
        <div class="card" style="border-left: 5px solid ${s.blacklist ? '#ff3b30' : '#34c759'};">
            <div onclick="toggleDettagli('${s.num}')" style="padding:15px; cursor:pointer;">
                <div style="display:flex; justify-content:space-between;">
                    <div style="flex:1">
                        <span style="font-weight:bold; color:#007aff;">#${s.num}</span>
                        <div style="font-size:15px; font-weight:600;">${s.titolo}</div>
                        <div style="font-size:11px; color:#888; margin-top:4px;">
                            ${s.ultimo ? `Ultimo: ${new Date(s.ultimo.data).toLocaleDateString()} (${s.ultimo.oratore})` : 'Mai pronunciato'}
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); toggleBlacklist('${s.num}')" style="background:none; border:none; font-size:20px;">
                        ${s.blacklist ? 'üö´' : '‚úÖ'}
                    </button>
                </div>
            </div>
            <div id="details-${s.num}" style="display:none; padding:15px; background:#f9f9f9; border-top:1px solid #eee;">
                <p style="font-weight:bold; margin:0 0 10px 0; font-size:12px;">Storico assegnazioni:</p>
                ${s.storico.map(e => `
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                        <span>${new Date(e.data).toLocaleDateString()} - ${e.oratore} (${e.luogo || 'N/D'})</span>
                        <button onclick="eliminaEvento(${e.id})" style="color:red; background:none; border:none; font-size:11px;">Elimina</button>
                    </div>
                `).join('') || '<span style="font-size:12px; color:#999;">Nessun dato</span>'}
                <button class="btn btn-schemi" style="width:100%; margin-top:10px; padding:10px; font-size:12px;" onclick="apriAssegnazione('${s.num}')">+ ASSEGNA ORA</button>
            </div>
        </div>
    `).join('');
}


        function toggleDettagli(num) {
            const el = document.getElementById(`details-${num}`);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function toggleBlacklist(num) {
            let schemi = getSchemi();
            const idx = schemi.findIndex(s => s.num === num);
            schemi[idx].blacklist = !schemi[idx].blacklist;
            localStorage.setItem('schemi', JSON.stringify(schemi));
            renderSchemi();
        }

        function cambiaMese(dir) { dataVisualizzata.setMonth(dataVisualizzata.getMonth() + dir); renderCalendario(); }
        function salvaGiornoAdunanza() { 
            giornoAdunanzaScelto = parseInt(document.getElementById('giornoAdunanza').value);
            localStorage.setItem('giornoAdunanza', giornoAdunanzaScelto);
            renderCalendario();
        }

        function renderCalendario() {
            const container = document.getElementById('calendario-render');
            const titolo = document.getElementById('meseCorrenteTitolo');
            titolo.innerText = dataVisualizzata.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
            
            const mese = dataVisualizzata.getMonth();
            const anno = dataVisualizzata.getFullYear();
            const eventi = getEventi();
            let html = '';
            let d = new Date(anno, mese, 1);

            while (d.getMonth() === mese) {
                if (d.getDay() === giornoAdunanzaScelto) {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const dIso = `${y}-${m}-${day}`;

                    const imp = eventi.find(e => {
    if (e.data !== dIso) return false;
    if (e.tipo === 'speciale') return true;
    
    // Modificato: restituisce l'evento se √® un discorso, sia interno che esterno
    return e.tipo === 'discorso'; 
});
                    
                    html += `
                    <div class="card" style="padding:15px; border-left: 6px solid ${imp ? (imp.tipo === 'speciale' ? '#ff3b30' : '#5856d6') : '#c7c7cc'}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="flex:1">
                                <div style="font-size:12px; color:#8e8e93; text-transform:uppercase;">${d.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric' })}</div>
                                ${renderContenutoGiorno(imp)}
                            </div>
                            <div style="display:flex; gap:10px;">
                                ${imp ? `<button onclick="eliminaEvento(${imp.id})" style="background:none; border:none; color:#ff3b30; font-size:24px;">‚úï</button>` : `<button onclick="assegnaDaCalendario('${dIso}')" style="background:none; border:none; color:#007aff; font-size:24px;">+</button>`}
                            </div>
                        </div>
                    </div>`;
                }
                d.setDate(d.getDate() + 1);
            }
            container.innerHTML = html || '<p style="text-align:center;">Nessun weekend.</p>';
        }

        function renderContenutoGiorno(imp) {
    if (!imp) return '<div style="font-weight:600; font-size:18px; color:#c7c7cc;">Libero</div>';
    
    if (imp.tipo === 'speciale') {
        return `<div style="font-weight:bold; font-size:18px; color:#ff3b30;">${imp.nome}</div>`;
    }

    const schemi = getSchemi();
    const sInfo = schemi.find(s => s.num === imp.schemaNum);
    const titolo = sInfo ? sInfo.titolo : "Titolo non trovato";
    
    // Logica corretta: se esiste imp.luogo e non √® la parola "INTERNO" (case insensitive)
    let infoCong = "";
    if (imp.luogo && imp.luogo.trim().toUpperCase() !== "INTERNO") {
        infoCong = `(${imp.luogo})`;
    } else {
        infoCong = "(Interno)";
    }

    return `
        <div style="font-weight:bold; font-size:18px; color:#1c1c1e; margin: 4px 0;">
            ${imp.oratore} <span style="font-weight:normal; color:#666; font-size:13px;">${infoCong}</span>
        </div>
        <div style="font-size:14px; color:#3a3a3c;">
            <strong>Schema ${imp.schemaNum}:</strong> ${titolo}
        </div>
    `;
}

        function assegnaDaCalendario(data) {
           popolaSuggerimenti(); document.getElementById('assignDate').value = data;
            document.getElementById('assignNum').value = "";
            document.getElementById('assignTitle').innerText = `Assegna Discorso`;
            document.getElementById('labelSchemaInput').style.display = 'block';
            document.getElementById('assignNumManuale').style.display = 'block';
            document.getElementById('assignLuogo').value = "INTERNO";
            document.getElementById('view-assegna').style.display = 'flex';
        }

        function apriAssegnazione(num) {
        popolaSuggerimenti();
            const s = getSchemi().find(x => x.num === num);
            if(s && s.blacklist && !confirm("Schema in Blacklist. Continuare?")) return;
            document.getElementById('assignNum').value = num;
            document.getElementById('assignTitle').innerText = `Assegna #${num}`;
            document.getElementById('labelSchemaInput').style.display = 'none';
            document.getElementById('assignNumManuale').style.display = 'none';
            document.getElementById('view-assegna').style.display = 'flex';
        }

        function chiudiAssegnazione() { 
            document.getElementById('view-assegna').style.display = 'none'; 
            document.getElementById('assignOratore').value = '';
            document.getElementById('assignNumManuale').value = '';
            document.getElementById('assignLuogo').value = '';
        }

        function confermaAssegnazione() {
    let num = document.getElementById('assignNum').value;
    const manuale = document.getElementById('assignNumManuale').value;
    if(!num && manuale) num = manuale;

    const data = document.getElementById('assignDate').value;
    const orat = document.getElementById('assignOratore').value.trim();
    
    // LEGGE IL LUOGO (Congregazione)
    let luogo = document.getElementById('assignLuogo').value.trim();
    
    if(!data || !orat || !num) return alert("Dati mancanti (Data, Oratore o Numero Schema)");

    // Controllo Blacklist
    const schemi = getSchemi();
    const schemaInfo = schemi.find(s => s.num === num);
    if(schemaInfo && schemaInfo.blacklist) {
        if(!confirm("‚ö†Ô∏è Lo schema #" + num + " √® in BLACKLIST. Procedere?")) return;
    }

    const avvisi = verificaConflitti(orat, num, data);
    if(avvisi && !confirm("ATTENZIONE:\n" + avvisi + "\nProcedere?")) return;

    let ev = getEventi();
    
    // MODIFICA QUI: Rimuove l'evento esistente per quella data nella nostra congregazione
    // (A prescindere che l'oratore sia lo stesso o meno, per evitare doppioni lo stesso giorno)
    const idx = ev.findIndex(e => e.data === data && e.tipo === 'discorso');
    if(idx !== -1) ev.splice(idx, 1);

    ev.push({ 
        id: Date.now(), 
        schemaNum: num, 
        data: data, 
        oratore: orat, 
        luogo: luogo,  
        tipo: 'discorso' 
    });
    
    localStorage.setItem('eventi', JSON.stringify(ev));
    chiudiAssegnazione();
    renderSchemi();
    renderCalendario();
    renderOratori(); 
    if(typeof renderEsterni === "function") renderEsterni(); // Aggiorna anche vista esterni se aperta
}

        function verificaConflitti(nome, schema, data) {
            const eventi = getEventi();
            const treMesi = 90 * 24 * 60 * 60 * 1000;
            let msg = "";
            
            const dataOggiStr = new Date(data);
            const meseOggi = dataOggiStr.getMonth();
            const annoOggi = dataOggiStr.getFullYear();

            eventi.forEach(e => {
                if(e.oratore && e.oratore.toLowerCase() === nome.toLowerCase()) {
                    const dataE = new Date(e.data);
                    const diff = Math.abs(dataOggiStr - dataE);
                    
                    // Conflitto 3 mesi
                    if(diff < treMesi) msg += `- Ha parlato il ${dataE.toLocaleDateString()} (< 3 mesi)\n`;
                    
                    // Conflitto stesso schema
                    if(e.schemaNum === schema) msg += `- Ha gi√† fatto lo schema #${schema} il ${dataE.toLocaleDateString()}\n`;
                    
                    // NUOVO: Conflitto stesso mese
                    if(dataE.getMonth() === meseOggi && dataE.getFullYear() === annoOggi) {
                        msg += `- ATTENZIONE: Ha gi√† un impegno il ${dataE.toLocaleDateString()} (Stesso Mese)\n`;
                    }
                }
            });
            return msg;
        }

        function apriModalEvento() { document.getElementById('modal-evento').style.display = 'flex'; }
        function chiudiModalEvento() { document.getElementById('modal-evento').style.display = 'none'; }
        
        function salvaEventoSpeciale() {
            const d = document.getElementById('eventDate').value;
            const t = document.getElementById('eventType').value;
            if(!d) return alert("Data mancante");
            let ev = getEventi();
            const idx = ev.findIndex(e => e.data === d);
            if(idx !== -1) ev.splice(idx, 1);
            ev.push({ id: Date.now(), data: d, tipo: 'speciale', nome: t });
            localStorage.setItem('eventi', JSON.stringify(ev));
            chiudiModalEvento();
            renderCalendario();
        }

        function eliminaEvento(id) {
            if(confirm("Eliminare?")) {
                let ev = getEventi().filter(e => e.id !== id);
                localStorage.setItem('eventi', JSON.stringify(ev));
                renderCalendario(); renderSchemi();
            }
        }

        let oratoreInModifica = null;
        function salvaOratore() {
            const nome = document.getElementById('oratNome').value.trim();
            if(!nome) return alert("Nome obbligatorio");
            let oratori = getOratori();
            const dati = {
                id: oratoreInModifica || Date.now(),
                nome,
                cong: document.getElementById('oratCong').value,
                tel: document.getElementById('oratTel').value,
                schemi: document.getElementById('oratSchemi').value,
                note: document.getElementById('oratNote').value
            };
            if(oratoreInModifica) {
                const idx = oratori.findIndex(o => o.id === oratoreInModifica);
                oratori[idx] = dati;
                oratoreInModifica = null;
                document.getElementById('btnSalvaOratore').innerText = "AGGIUNGI ORATORE";
            } else { oratori.push(dati); }
            localStorage.setItem('oratori', JSON.stringify(oratori));
            ['oratNome', 'oratCong', 'oratTel', 'oratSchemi', 'oratNote'].forEach(id => document.getElementById(id).value = '');
            renderOratori();
        }

        function pulisciRicercaOratori() {
    document.getElementById('searchOratore').value = '';
    renderOratori();
    document.getElementById('searchOratore').focus();
}

function renderOratori() {
    const container = document.getElementById('lista-oratori-render');
    const counter = document.getElementById('counter-risultati');
    const query = document.getElementById('searchOratore').value.toLowerCase();
    const oggi = new Date().toISOString().split('T')[0];
    const eventi = getEventi();
    const tuttiSchemi = getSchemi();
    
    let oratoriFiltrati = getOratori();

    // Filtro
    if (query) {
        oratoriFiltrati = oratoriFiltrati.filter(o => {
            const nomeMatch = o.nome.toLowerCase().includes(query);
            const schemiPosseduti = o.schemi.split(',').map(s => s.trim());
            const numeroSchemaMatch = schemiPosseduti.some(n => n.includes(query));
            const titoloSchemaMatch = schemiPosseduti.some(n => {
                const sInfo = tuttiSchemi.find(s => s.num === n);
                return sInfo && sInfo.titolo.toLowerCase().includes(query);
            });
            return nomeMatch || numeroSchemaMatch || titoloSchemaMatch;
        });
        counter.innerText = `Risultati trovati: ${oratoriFiltrati.length}`;
    } else {
        counter.innerText = "";
    }

    container.innerHTML = oratoriFiltrati.map(o => {
        const impegniFuturi = eventi
            .filter(e => e.oratore === o.nome && e.data >= oggi)
            .sort((a,b) => new Date(a.data) - new Date(b.data));

        let previewHtml = "";
        if(impegniFuturi.length > 0) {
            previewHtml = `
            <div id="preview-${o.id}" class="preview-box" style="display:none; background: #f0f0f7; border-radius: 8px; padding: 10px; margin-top: 10px; font-size: 12px; border-left: 3px solid var(--btn-interni);">
                <strong>Anteprima Prossimi Impegni:</strong><br>
                ${impegniFuturi.map(i => `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; border-bottom:1px solid #ddd; padding-bottom:2px;">
                        <span>‚Ä¢ ${new Date(i.data).toLocaleDateString()}: #${i.schemaNum} (${i.luogo || 'N/D'})</span>
                        <button onclick="apriModificaAppuntamento(${i.id})" style="background:none; border:none; color:var(--btn-interni); font-size:10px; font-weight:bold;">MODIFICA</button>
                    </div>
                `).join('')}
            </div>`;
        } else {
            previewHtml = `<div id="preview-${o.id}" class="preview-box" style="display:none; color:#999; padding:10px;">Nessun impegno futuro.</div>`;
        }

        // Determiniamo se la query √® un numero per passarla all'assegnazione veloce
        const schemaSuggerito = (query && !isNaN(query)) ? query : "";

        return `
        <div class="card" style="padding:15px; border-left: 5px solid var(--btn-interni);">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <div>
                    <strong class="clickable-name" onclick="apriAssegnazioneVeloce('${o.nome.replace(/'/g, "\\'")}', 'INTERNO', '${schemaSuggerito}')">${o.nome}</strong><br>
                    <small>${o.cong} ${o.tel ? '‚Ä¢ '+o.tel : ''}</small><br>
                    <small style="color:#555; font-size:11px;">
                        Schemi: ${o.schemi ? o.schemi.split(',').map(s => {
                            const n = s.trim();
                            // Applica evidenziazione gialla se il numero corrisponde alla ricerca
                            const highlight = (query && n === query) ? 'style="background:yellow; font-weight:bold; padding:0 2px; border-radius:3px;"' : '';
                            return `<span ${highlight}>${n}</span>`;
                        }).join(', ') : 'Nessuno'}
                    </small>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="caricaOratore(${o.id})" style="border:none; background:none; font-size:18px; cursor:pointer;">‚úèÔ∏è</button>
                    <button onclick="eliminaOratore(${o.id})" style="border:none; background:none; color:red; font-size:18px; cursor:pointer;">‚úï</button>
                </div>
            </div>
            <div style="margin-top:10px;">
                <button class="btn-backup" style="color:var(--btn-interni); padding:0; cursor:pointer;" onclick="toggleAnteprima(${o.id})">üëÅÔ∏è Mostra/Nascondi Anteprima</button>
            </div>
            ${previewHtml}
            <button class="btn-backup" style="color:var(--btn-calendario); margin-top:10px; width:100%; text-align:left; padding:0; cursor:pointer;" onclick="generaPDFOratore(${o.id})">üìÑ SCARICA PDF</button>
        </div>`;
    }).join('');
}

function apriModificaAppuntamento(idEvento) {
    const ev = getEventi().find(e => e.id === idEvento);
    if (!ev) return;

    document.getElementById('assignDate').value = ev.data;
    document.getElementById('assignOratore').value = ev.oratore;
    document.getElementById('assignNum').value = ev.schemaNum;
    document.getElementById('assignNumManuale').value = ev.schemaNum;
    document.getElementById('assignLuogo').value = ev.luogo || "INTERNO";
    document.getElementById('assignTitle').innerText = `Modifica Appuntamento`;
    
    document.getElementById('labelSchemaInput').style.display = 'block';
    document.getElementById('assignNumManuale').style.display = 'block';
    
    // Rimuoviamo il vecchio ID per evitare duplicati al salvataggio
    let tuttiEventi = getEventi().filter(e => e.id !== idEvento);
    localStorage.setItem('eventi', JSON.stringify(tuttiEventi));

    document.getElementById('view-assegna').style.display = 'flex';
}
        function apriAssegnazioneVeloce(nome, congregazione, schema) {
        popolaSuggerimenti();
    // 1. Inserisce i dati dell'oratore e del luogo
    document.getElementById('assignOratore').value = nome;
    document.getElementById('assignLuogo').value = congregazione || "INTERNO";

    // 2. Gestione dello Schema (Numerico e Manuale)
    const campoSchemaSelect = document.getElementById('assignNum');
    const campoSchemaManuale = document.getElementById('assignNumManuale');
    const labelSchema = document.getElementById('labelSchemaInput'); // Il contenitore del campo manuale

    if (schema) {
        campoSchemaSelect.value = schema;
        campoSchemaManuale.value = schema;
    } else {
        campoSchemaSelect.value = "";
        campoSchemaManuale.value = "";
    }

    // IMPORTANTE: Assicurati che i campi siano VISIBILI
    // In alcuni script questi campi vengono nascosti se non resettati
    if (campoSchemaSelect) campoSchemaSelect.style.display = 'block';
    if (campoSchemaManuale) campoSchemaManuale.style.display = 'block';
    if (labelSchema) labelSchema.style.display = 'block';

    // 3. Resetta data e titolo della modale
    document.getElementById('assignDate').value = "";
    document.getElementById('assignTitle').innerText = `Assegna per ${nome}`;
    
    // 4. Mostra la vista di assegnazione
    document.getElementById('view-assegna').style.display = 'flex';
}

        function caricaOratore(id) {
            const o = getOratori().find(i => i.id === id);
            document.getElementById('oratNome').value = o.nome;
            document.getElementById('oratCong').value = o.cong;
            document.getElementById('oratTel').value = o.tel;
            document.getElementById('oratSchemi').value = o.schemi;
            document.getElementById('oratNote').value = o.note;
            oratoreInModifica = id;
            document.getElementById('btnSalvaOratore').innerText = "MODIFICA ORATORE";
            window.scrollTo(0,0);
        }

        function eliminaOratore(id) {
            if(confirm("Eliminare oratore?")) {
                let oratori = getOratori().filter(o => o.id !== id);
                localStorage.setItem('oratori', JSON.stringify(oratori));
                renderOratori();
            }
        }

        function popolaSuggerimenti() {
    const list = document.getElementById('lista-suggerimenti');
    list.innerHTML = ""; 

    const interni = JSON.parse(localStorage.getItem('oratori')) || [];
    const esterni = JSON.parse(localStorage.getItem('oratori_esterni')) || [];
    const tutti = [...interni, ...esterni];

    tutti.forEach(o => {
        const option = document.createElement('option');
        // MODIFICA FONDAMENTALE:
        // Inseriamo la congregazione nel valore usando le parentesi quadre
        // Cos√¨ "Mario Rossi [Roma]" √® diverso da "Mario Rossi [Milano]"
        option.value = `${o.nome} [${o.cong}]`; 
        list.appendChild(option);
    });
}


/// NUOVO LISTENER "INTELLIGENTE" PER OMONIMI
document.getElementById('assignOratore').addEventListener('input', function(e) {
    const valore = e.target.value;

    // Controlliamo se nel campo c'√® una parentesi quadra aperta (segno che √® stato selezionato un suggerimento)
    if (valore.includes('[')) {
        // Separiamo il nome dalla congregazione
        // Esempio input: "Mario Rossi [Roma Est]"
        const parti = valore.split('[');
        const nomeVero = parti[0].trim(); // Diventa "Mario Rossi"
        let congVera = parti[1].replace(']', '').trim(); // Diventa "Roma Est"

        // Aggiorniamo i campi automaticamente
        // Usiamo un piccolo ritardo (setTimeout) per assicurarci che l'interfaccia non si blocchi
        setTimeout(() => {
            document.getElementById('assignOratore').value = nomeVero;
            
            // Se c'√® una congregazione, la inseriamo, altrimenti mettiamo INTERNO se vuota
            if (congVera) {
                document.getElementById('assignLuogo').value = congVera;
            }
        }, 10);
    }
});


        async function generaPDFOratore(id) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const oggi = new Date().toISOString().split('T')[0];
            const o = getOratori().find(x => x.id === id);
            
            // Il PDF mostra solo da oggi in poi
            const impegni = getEventi()
                .filter(e => e.oratore === o.nome && e.data >= oggi)
                .sort((a,b) => new Date(a.data) - new Date(b.data));
                
            doc.setFontSize(16);
            doc.text(`Programma Individuale: ${o.nome}`, 14, 20);
            doc.setFontSize(10);
            doc.text(`Congregazione di appartenenza: ${o.cong}`, 14, 28);
            doc.text(`Aggiornato al: ${new Date().toLocaleDateString()}`, 14, 33);
            
            doc.autoTable({ 
                startY: 40, 
                head: [['Data', 'Schema', 'Luogo / Congregazione']], 
                body: impegni.map(i => [
                    new Date(i.data).toLocaleDateString(), 
                    "#"+i.schemaNum,
                    i.luogo || 'Non specificato'
                ]) 
            });
            doc.save(`Programma_${o.nome}.pdf`);
        }

        function downloadS99() { window.open("https://asarritzu-boop.github.io/Discorsi_Pubblici/S-99.csv"); }
        function exportCSV() {
            let csv = "Numero;Titolo\n" + getSchemi().map(s => `${s.num};${s.titolo}`).join("\n");
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "schemi.csv"; a.click();
        }
        function importCSV(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const rows = ev.target.result.split("\n").slice(1);
                let schemi = getSchemi();
                rows.forEach(r => {
                    const [n, t] = r.split(";");
                    if(n && t && !schemi.some(s => s.num === n.trim())) schemi.push({ num: n.trim(), titolo: t.trim(), blacklist: false });
                });
                localStorage.setItem('schemi', JSON.stringify(schemi)); renderSchemi();
            };
            reader.readAsText(e.target.files[0]);
        }

        function exportOratoriCSV() {
            let csv = "Nome;Congregazione;Telefono;Schemi;Note\n" + getOratori().map(o => `"${o.nome}";"${o.cong}";"${o.tel}";"${o.schemi}";"${o.note}"`).join("\n");
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "oratori.csv"; a.click();
        }

        function importOratoriCSV(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const rows = ev.target.result.split("\n").slice(1);
                let oratori = getOratori();
                rows.forEach(r => {
                    const cols = r.split(";").map(c => c.replace(/"/g, '').trim());
                    if(cols[0]) {
                        oratori.push({ id: Date.now() + Math.random(), nome: cols[0], cong: cols[1]||'', tel: cols[2]||'', schemi: cols[3]||'', note: cols[4]||'' });
                    }
                });
                localStorage.setItem('oratori', JSON.stringify(oratori)); renderOratori();
            };
            reader.readAsText(e.target.files[0]);
        }

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
        renderCalendario();

function toggleAnteprima(id) {
    const el = document.getElementById(`preview-${id}`);
    if (el.style.display === "none") {
        el.style.display = "block";
    } else {
        el.style.display = "none";
    }
}

function getOratoriEsterni() { return JSON.parse(localStorage.getItem('oratori_esterni')) || []; }

let esternoInModifica = null;
function salvaOratoreEsterno() {
    const nome = document.getElementById('extNome').value.trim();
    const cong = document.getElementById('extCong').value.trim();
    if(!nome || !cong) return alert("Nome e Congregazione obbligatori");

    let oratori = getOratoriEsterni();
    const dati = {
        id: esternoInModifica || Date.now(),
        nome,
        cong,
        tel: document.getElementById('extTel').value,
        schemi: document.getElementById('extSchemi').value,
        note: document.getElementById('extNote').value
    };

    if(esternoInModifica) {
        const idx = oratori.findIndex(o => o.id === esternoInModifica);
        oratori[idx] = dati;
        esternoInModifica = null;
        document.getElementById('btnSalvaEsterno').innerText = "AGGIUNGI ORATORE ESTERNO";
    } else { oratori.push(dati); }

    localStorage.setItem('oratori_esterni', JSON.stringify(oratori));
    ['extNome', 'extCong', 'extTel', 'extSchemi', 'extNote'].forEach(id => document.getElementById(id).value = '');
    renderEsterni();
}

function renderEsterni() {
    const container = document.getElementById('lista-esterni-render');
    const counter = document.getElementById('counter-risultati-ext');
    const query = document.getElementById('searchEsterno').value.toLowerCase();
    const oratori = getOratoriEsterni();
    const tuttiSchemi = getSchemi(); 
    
    let totaleTrovati = 0;

    // 1. Raggruppamento e Filtro Logico
    const gruppi = oratori.reduce((acc, orat) => {
        const nomeMatch = orat.nome.toLowerCase().includes(query);
        const congMatch = orat.cong.toLowerCase().includes(query);
        const schemiArray = orat.schemi.split(',').map(s => s.trim());
        
        // Verifica se il numero dello schema corrisponde alla ricerca
        const numeroSchemaMatch = schemiArray.some(n => n.includes(query));
        
        // Verifica se il titolo dello schema corrispondente contiene la ricerca
        const titoloSchemaMatch = schemiArray.some(n => {
            const sInfo = tuttiSchemi.find(s => s.num === n);
            return sInfo && sInfo.titolo.toLowerCase().includes(query);
        });

        if (!query || nomeMatch || congMatch || numeroSchemaMatch || titoloSchemaMatch) {
            if (!acc[orat.cong]) acc[orat.cong] = [];
            acc[orat.cong].push(orat);
            totaleTrovati++;
        }
        return acc;
    }, {});

    // 2. Aggiorna il contatore dei risultati
    if (query) {
        counter.innerHTML = `<span style="color:var(--btn-esterni)">Risultati trovati: ${totaleTrovati}</span>`;
    } else {
        counter.innerText = "";
    }

    // 3. Generazione HTML
    let html = "";
    const congregazioniOrdinate = Object.keys(gruppi).sort();

    congregazioniOrdinate.forEach(cong => {
        // Se c'√® una ricerca, le cartelle sono aperte di default (block), altrimenti chiuse (none)
        const displayStato = query ? 'block' : 'none';
        const idCong = `cong-${cong.replace(/\s+/g, '')}`;

        html += `
        <div class="card" style="border-left: 5px solid var(--btn-esterni); margin-bottom:10px;">
            <div onclick="toggleDettagliEsterni('${cong}')" style="padding:15px; cursor:pointer; background:#f8f9fa; display:flex; justify-content:space-between; align-items:center;">
                <strong style="color:var(--btn-esterni); text-transform:uppercase; font-size:14px;">${cong}</strong>
                <span style="font-size:11px; background:#e5e5ea; padding:2px 8px; border-radius:10px; color:#3a3a3c;">${gruppi[cong].length} oratori</span>
            </div>
            
            <div id="${idCong}" style="display:${displayStato}; padding:5px 10px; border-top:1px solid #eee; background:white;">
                ${gruppi[cong].map(o => {
                    // Se la query √® un numero, la passiamo come suggerimento per lo schema
                    const schemaSuggerito = isNaN(query) || query === "" ? "" : query;
                    
                    return `
                    <div style="padding:12px 0; border-bottom:1px solid #f2f2f7; display:flex; justify-content:space-between; align-items:center;">
                        <div style="flex:1; padding-right:10px;">
                            <div style="font-weight:bold; color:var(--btn-interni); font-size:16px; cursor:pointer;" 
                                 onclick="apriAssegnazioneVeloce('${o.nome.replace(/'/g, "\\'")}', '${o.cong.replace(/'/g, "\\'")}', '${schemaSuggerito}')">
                                 ${o.nome}
                            </div>
                            <div style="font-size:12px; color:#666; margin-top:2px;">
                                <a href="tel:${o.tel}" style="text-decoration:none; color:inherit;">üìû ${o.tel || 'No tel'}</a>
                            </div>
                            <div style="font-size:12px; color:#3a3a3c; margin-top:5px; line-height:1.4;">
                                <strong>Schemi:</strong> ${o.schemi.split(',').map(s => {
                                    const n = s.trim();
                                    const m = (query && n === query) ? `style="background:yellow; font-weight:bold; padding:0 2px;"` : '';
                                    return `<span ${m}>${n}</span>`;
                                }).join(', ')}
                            </div>
                        </div>
                        <div style="display:flex; gap:15px;">
                            <button onclick="caricaEsterno(${o.id})" style="border:none; background:none; font-size:18px; cursor:pointer;">‚úèÔ∏è</button>
                            <button onclick="eliminaEsterno(${o.id})" style="border:none; background:none; color:#ff3b30; font-size:18px; cursor:pointer;">‚úï</button>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>`;
    });

    container.innerHTML = html || '<p style="text-align:center; color:#8e8e93; margin-top:30px;">Nessun oratore esterno trovato.</p>';
}

// Funzione di supporto per aprire/chiudere le congregazioni
function toggleDettagliEsterni(cong) {
    const id = `cong-${cong.replace(/\s+/g, '')}`;
    const el = document.getElementById(id);
    if (el) {
        el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
    }
}

function caricaEsterno(id) {
    const o = getOratoriEsterni().find(i => i.id === id);
    document.getElementById('extNome').value = o.nome;
    document.getElementById('extCong').value = o.cong;
    document.getElementById('extTel').value = o.tel;
    document.getElementById('extSchemi').value = o.schemi;
    document.getElementById('extNote').value = o.note;
    esternoInModifica = id;
    document.getElementById('btnSalvaEsterno').innerText = "MODIFICA ESTERNO";
    window.scrollTo(0,0);
}

function eliminaEsterno(id) {
    if(confirm("Eliminare oratore esterno?")) {
        let oratori = getOratoriEsterni().filter(o => o.id !== id);
        localStorage.setItem('oratori_esterni', JSON.stringify(oratori));
        renderEsterni();
    }
}

function exportEsterniCSV() {
    const oratori = getOratoriEsterni();
    if (oratori.length === 0) return alert("Nessun dato da esportare");
    
    let csv = "Nome;Congregazione;Telefono;Schemi;Note\n" + 
        oratori.map(o => `"${o.nome}";"${o.cong}";"${o.tel}";"${o.schemi}";"${o.note}"`).join("\n");
    
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "oratori_esterni.csv";
    a.click();
}

function importEsterniCSV(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
        try {
            const content = ev.target.result;
            // Divide per linee e rimuove l'intestazione
            const rows = content.split(/\r?\n/).slice(1); 
            let oratori = getOratoriEsterni();
            let contatore = 0;
            
            rows.forEach(r => {
                if (r.trim() === "") return;
                
                // Gestione flessibile del separatore (prova ; poi ,)
                let cols = r.split(";");
                if (cols.length < 2) cols = r.split(",");
                
                cols = cols.map(c => c.replace(/"/g, '').trim());

                if(cols[0] && cols[1]) { // Nome e Congregazione minimi
                    oratori.push({ 
                        id: Date.now() + Math.random(), 
                        nome: cols[0], 
                        cong: cols[1], 
                        tel: cols[2] || '', 
                        schemi: cols[3] || '', 
                        note: cols[4] || '' 
                    });
                    contatore++;
                }
            });
            
            localStorage.setItem('oratori_esterni', JSON.stringify(oratori));
            renderEsterni();
            alert("Importazione completata! Aggiunti " + contatore + " oratori.");
        } catch (err) {
            console.error("Errore importazione:", err);
            alert("Errore durante la lettura del file CSV.");
        }
        e.target.value = ''; // Reset input file
    };
    reader.readAsText(file);
}


function pulisciRicercaEsterni() {
    document.getElementById('searchEsterno').value = ''; // Pulisce il campo
    renderEsterni(); // Ricarica la lista completa
    document.getElementById('searchEsterno').focus(); // Riporta il focus sull'input
}
async function generaPDFSchemiFiltrati() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Recupera i valori dei filtri attuali
    const query = document.getElementById('searchSchema').value.toLowerCase();
    const anniMin = parseInt(document.getElementById('filterAnni').value) || 0;
    const sort = document.getElementById('sortOrder').value;
    const eventi = getEventi();

    // Applica la stessa logica di filtraggio di renderSchemi()
    let schemi = getSchemi().map(s => {
        const storico = eventi.filter(e => e.schemaNum === s.num).sort((a,b) => new Date(b.data) - new Date(a.data));
        return { ...s, ultimo: storico[0] || null };
    });

    if(query) schemi = schemi.filter(s => s.num.includes(query) || s.titolo.toLowerCase().includes(query));
    if(anniMin > 0) {
        const limite = new Date(); limite.setFullYear(limite.getFullYear() - anniMin);
        schemi = schemi.filter(s => !s.ultimo || new Date(s.ultimo.data) <= limite);
    }

    // Ordinamento
    schemi.sort((a,b) => {
        if(sort === 'num_asc') return a.num - b.num;
        const dA = a.ultimo ? new Date(a.ultimo.data) : new Date(0);
        const dB = b.ultimo ? new Date(b.ultimo.data) : new Date(0);
        return sort === 'date_asc' ? dA - dB : dB - dA;
    });

    // Costruzione del PDF
    doc.setFontSize(16);
    doc.text("Elenco Schemi Discorsi", 14, 20);
    doc.setFontSize(10);
    doc.text(`Filtri: ${query || 'Nessuno'} | Anni: ${anniMin} | Ordine: ${sort}`, 14, 28);

    const tableBody = schemi.map(s => [
        s.num,
        s.titolo,
        s.ultimo ? new Date(s.ultimo.data).toLocaleDateString() : 'Mai pronunciato',
        s.ultimo ? s.ultimo.oratore : '-'
    ]);

    doc.autoTable({
        startY: 35,
        head: [['N¬∞', 'Titolo', 'Ultima Data', 'Oratore']],
        body: tableBody,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [255, 149, 0] } // Colore arancione come il tuo pulsante schemi
    });

    doc.save("lista_schemi_filtrata.pdf");
}

function pulisciRicercaSchemi() {
    document.getElementById('searchSchema').value = '';
    document.getElementById('filterAnni').value = 0; // Opzionale: resetta anche gli anni
    renderSchemi();
    document.getElementById('searchSchema').focus();
}

        
    </script>
</body>
</html>
